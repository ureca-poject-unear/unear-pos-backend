name: Close Jira Issue
on:
  issues:
    types:
      - closed
  pull_request:
    types:
      - closed

jobs:
  close-jira-issue:
    name: Close Jira Issue
    runs-on: ubuntu-latest
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      # GitHub Issue가 닫힐 때
      - name: Extract Jira Issue Key from GitHub Issue Title
        if: ${{ github.event_name == 'issues' }}
        id: extract-issue-key
        run: |
          TITLE="${{ github.event.issue.title }}"
          echo "GitHub Issue Title: $TITLE"
          
          # [WL7-123] 형태로 제목에 있는 Jira 키 추출
          if [[ "$TITLE" =~ \[([A-Z]+-[0-9]+)\] ]]; then
            JIRA_KEY="${BASH_REMATCH[1]}"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "Found Jira key: $JIRA_KEY"
          else
            echo "No Jira key found in title"
            echo "jira_key=" >> $GITHUB_OUTPUT
          fi

      # Pull Request가 머지될 때 - 제목에서만 추출
      - name: Extract Jira Issue Key from PR Title
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged == true }}
        id: extract-pr-key
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          echo "PR Title: $PR_TITLE"
          
          # PR 제목에서 [WL7-123] 패턴으로 Jira 키 찾기
          if [[ "$PR_TITLE" =~ \[([A-Z]+-[0-9]+)\] ]]; then
            JIRA_KEY="${BASH_REMATCH[1]}"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "Found Jira key in PR title: $JIRA_KEY"
          else
            echo "No Jira key found in PR title"
            echo "jira_key=" >> $GITHUB_OUTPUT
          fi

      - name: Set final Jira key
        id: final-key
        run: |
          if [ "${{ github.event_name }}" == "issues" ]; then
            echo "jira_key=${{ steps.extract-issue-key.outputs.jira_key }}" >> $GITHUB_OUTPUT
          else
            echo "jira_key=${{ steps.extract-pr-key.outputs.jira_key }}" >> $GITHUB_OUTPUT
          fi

      - name: Close Jira issue
        if: ${{ steps.final-key.outputs.jira_key != '' }}
        id: close-issue
        run: |
          JIRA_KEY="${{ steps.final-key.outputs.jira_key }}"
          
          echo "Processing $JIRA_KEY..."
          
          # 현재 상태 확인
          STATUS_RESPONSE=$(curl -s -X GET \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$JIRA_KEY")
          
          if echo "$STATUS_RESPONSE" | jq -e '.fields.status.name' > /dev/null; then
            CURRENT_STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.fields.status.name')
            echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
            echo "Current status of $JIRA_KEY: $CURRENT_STATUS"
            
            # 이미 완료된 이슈는 스킵
            if [[ "$CURRENT_STATUS" == "완료" || "$CURRENT_STATUS" == "Done" || "$CURRENT_STATUS" == "DONE" ]]; then
              echo "already_done=true" >> $GITHUB_OUTPUT
              echo "$JIRA_KEY is already done, skipping"
              exit 0
            fi
            
            # 가능한 전환 상태 조회
            TRANSITIONS=$(curl -s -X GET \
              -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
              -H "Content-Type: application/json" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$JIRA_KEY/transitions")
            
            # "완료" 또는 "Done" 전환 ID 찾기
            DONE_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.name == "완료" or .name == "Done" or .name == "DONE" or .name == "Close") | .id' | head -1)
            
            if [ ! -z "$DONE_ID" ]; then
              echo "Transitioning $JIRA_KEY to Done with ID: $DONE_ID"
              
              TRANSITION_RESPONSE=$(curl -s -X POST \
                -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
                -H "Content-Type: application/json" \
                -d "{\"transition\":{\"id\":\"$DONE_ID\"}}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$JIRA_KEY/transitions")
              
              echo "success=true" >> $GITHUB_OUTPUT
              echo "✅ Successfully closed $JIRA_KEY"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "❌ No 'Done' transition found for $JIRA_KEY"
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "❌ Failed to get status for $JIRA_KEY"
          fi

      - name: Add comment to GitHub
        if: ${{ steps.final-key.outputs.jira_key != '' }}
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number || github.event.pull_request.number }}
          body: |
            ## 🎯 Jira 이슈 상태 업데이트
            
            **Jira Issue:** [${{ steps.final-key.outputs.jira_key }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.final-key.outputs.jira_key }})
            **이전 상태:** ${{ steps.close-issue.outputs.current_status }}
            **결과:** ${{ steps.close-issue.outputs.already_done == 'true' && '이미 완료됨' || (steps.close-issue.outputs.success == 'true' && '✅ 완료 처리됨' || '❌ 완료 실패') }}
            **트리거:** ${{ github.event_name == 'issues' && 'GitHub Issue 닫힘' || 'PR 머지됨' }}
            
            🔗 **Jira에서 확인**: [이슈 보기](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.final-key.outputs.jira_key }})
