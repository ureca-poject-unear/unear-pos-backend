name: Close Jira Issue
on:
  issues:
    types:
      - closed
  pull_request:
    types:
      - closed

jobs:
  close-jira-issue:
    name: Close Jira Issue
    runs-on: ubuntu-latest
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      # GitHub Issueê°€ ë‹«í ë•Œ
      - name: Extract Jira Issue Key from GitHub Issue Title
        if: ${{ github.event_name == 'issues' }}
        id: extract-issue-key
        run: |
          TITLE="${{ github.event.issue.title }}"
          echo "GitHub Issue Title: $TITLE"
          
          # [WL7-123] í˜•íƒœë¡œ ì œëª©ì— ìˆëŠ” Jira í‚¤ ì¶”ì¶œ
          if [[ "$TITLE" =~ \[([A-Z]+-[0-9]+)\] ]]; then
            JIRA_KEY="${BASH_REMATCH[1]}"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "Found Jira key: $JIRA_KEY"
          else
            echo "No Jira key found in title"
            echo "jira_key=" >> $GITHUB_OUTPUT
          fi

      # Pull Requestê°€ ë¨¸ì§€ë  ë•Œ - ì œëª©ì—ì„œë§Œ ì¶”ì¶œ
      - name: Extract Jira Issue Key from PR Title
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged == true }}
        id: extract-pr-key
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          echo "PR Title: $PR_TITLE"
          
          # PR ì œëª©ì—ì„œ [WL7-123] íŒ¨í„´ìœ¼ë¡œ Jira í‚¤ ì°¾ê¸°
          if [[ "$PR_TITLE" =~ \[([A-Z]+-[0-9]+)\] ]]; then
            JIRA_KEY="${BASH_REMATCH[1]}"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "Found Jira key in PR title: $JIRA_KEY"
          else
            echo "No Jira key found in PR title"
            echo "jira_key=" >> $GITHUB_OUTPUT
          fi

      - name: Set final Jira key
        id: final-key
        run: |
          if [ "${{ github.event_name }}" == "issues" ]; then
            echo "jira_key=${{ steps.extract-issue-key.outputs.jira_key }}" >> $GITHUB_OUTPUT
          else
            echo "jira_key=${{ steps.extract-pr-key.outputs.jira_key }}" >> $GITHUB_OUTPUT
          fi

      - name: Close Jira issue
        if: ${{ steps.final-key.outputs.jira_key != '' }}
        id: close-issue
        run: |
          JIRA_KEY="${{ steps.final-key.outputs.jira_key }}"
          
          echo "Processing $JIRA_KEY..."
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          STATUS_RESPONSE=$(curl -s -X GET \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$JIRA_KEY")
          
          if echo "$STATUS_RESPONSE" | jq -e '.fields.status.name' > /dev/null; then
            CURRENT_STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.fields.status.name')
            echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
            echo "Current status of $JIRA_KEY: $CURRENT_STATUS"
            
            # ì´ë¯¸ ì™„ë£Œëœ ì´ìŠˆëŠ” ìŠ¤í‚µ
            if [[ "$CURRENT_STATUS" == "ì™„ë£Œ" || "$CURRENT_STATUS" == "Done" || "$CURRENT_STATUS" == "DONE" ]]; then
              echo "already_done=true" >> $GITHUB_OUTPUT
              echo "$JIRA_KEY is already done, skipping"
              exit 0
            fi
            
            # ê°€ëŠ¥í•œ ì „í™˜ ìƒíƒœ ì¡°íšŒ
            TRANSITIONS=$(curl -s -X GET \
              -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
              -H "Content-Type: application/json" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$JIRA_KEY/transitions")
            
            # "ì™„ë£Œ" ë˜ëŠ” "Done" ì „í™˜ ID ì°¾ê¸°
            DONE_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.name == "ì™„ë£Œ" or .name == "Done" or .name == "DONE" or .name == "Close") | .id' | head -1)
            
            if [ ! -z "$DONE_ID" ]; then
              echo "Transitioning $JIRA_KEY to Done with ID: $DONE_ID"
              
              TRANSITION_RESPONSE=$(curl -s -X POST \
                -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
                -H "Content-Type: application/json" \
                -d "{\"transition\":{\"id\":\"$DONE_ID\"}}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$JIRA_KEY/transitions")
              
              echo "success=true" >> $GITHUB_OUTPUT
              echo "âœ… Successfully closed $JIRA_KEY"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "âŒ No 'Done' transition found for $JIRA_KEY"
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Failed to get status for $JIRA_KEY"
          fi

      - name: Add comment to GitHub
        if: ${{ steps.final-key.outputs.jira_key != '' }}
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number || github.event.pull_request.number }}
          body: |
            ## ğŸ¯ Jira ì´ìŠˆ ìƒíƒœ ì—…ë°ì´íŠ¸
            
            **Jira Issue:** [${{ steps.final-key.outputs.jira_key }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.final-key.outputs.jira_key }})
            **ì´ì „ ìƒíƒœ:** ${{ steps.close-issue.outputs.current_status }}
            **ê²°ê³¼:** ${{ steps.close-issue.outputs.already_done == 'true' && 'ì´ë¯¸ ì™„ë£Œë¨' || (steps.close-issue.outputs.success == 'true' && 'âœ… ì™„ë£Œ ì²˜ë¦¬ë¨' || 'âŒ ì™„ë£Œ ì‹¤íŒ¨') }}
            **íŠ¸ë¦¬ê±°:** ${{ github.event_name == 'issues' && 'GitHub Issue ë‹«í˜' || 'PR ë¨¸ì§€ë¨' }}
            
            ğŸ”— **Jiraì—ì„œ í™•ì¸**: [ì´ìŠˆ ë³´ê¸°](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.final-key.outputs.jira_key }})
