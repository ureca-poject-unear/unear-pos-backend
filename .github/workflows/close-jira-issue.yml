name: Close Jira Issue
on:
  issues:
    types:
      - closed

jobs:
  close-jira-issue:
    name: Close Jira Issue
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira Issue Key from GitHub Issue Title
        id: extract-issue-key
        run: |
          TITLE="${{ github.event.issue.title }}"
          echo "GitHub Issue Title: $TITLE"
          
          # [WL7-123] í˜•íƒœë¡œ ì œëª©ì— ìˆëŠ” Jira í‚¤ ì¶”ì¶œ
          if [[ "$TITLE" =~ \[([A-Z0-9]+-[0-9]+)\] ]]; then
            JIRA_KEY="${BASH_REMATCH[1]}"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "Found Jira key: $JIRA_KEY"
          else
            echo "No Jira key found in title"
            echo "jira_key=" >> $GITHUB_OUTPUT
          fi

      - name: Close Jira Issue
        if: ${{ steps.extract-issue-key.outputs.jira_key != '' }}
        id: close-issue
        run: |
          set -e
          
          JIRA_KEY="${{ steps.extract-issue-key.outputs.jira_key }}"
          JIRA_BASE_URL="${{ secrets.JIRA_BASE_URL }}"
          
          echo "Processing $JIRA_KEY..."
          
          # ê¸°ë³¸ ì¸ì¦ í—¤ë” ì„¤ì •
          AUTH_HEADER="Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)"
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          echo "Fetching current status..."
          STATUS_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X GET \
            -H "$AUTH_HEADER" \
            -H "Content-Type: application/json" \
            "$JIRA_BASE_URL/rest/api/2/issue/$JIRA_KEY")
          
          # HTTP ìƒíƒœ ì½”ë“œ ì¶”ì¶œ
          HTTP_CODE=$(echo $STATUS_RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          RESPONSE_BODY=$(echo $STATUS_RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Failed to get issue status. HTTP Code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error_message=Failed to fetch issue status (HTTP $HTTP_CODE)" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          if ! echo "$RESPONSE_BODY" | jq -e '.fields.status.name' > /dev/null 2>&1; then
            echo "âŒ Invalid response format"
            echo "Response: $RESPONSE_BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error_message=Invalid response format" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          CURRENT_STATUS=$(echo "$RESPONSE_BODY" | jq -r '.fields.status.name')
          echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
          echo "Current status of $JIRA_KEY: $CURRENT_STATUS"
          
          # ì´ë¯¸ ì™„ë£Œëœ ì´ìŠˆëŠ” ìŠ¤í‚µ
          if [[ "$CURRENT_STATUS" == "ì™„ë£Œ" || "$CURRENT_STATUS" == "Done" || "$CURRENT_STATUS" == "DONE" || "$CURRENT_STATUS" == "Closed" ]]; then
            echo "already_done=true" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
            echo "$JIRA_KEY is already done, skipping"
            exit 0
          fi
          
          echo "already_done=false" >> $GITHUB_OUTPUT
          
          # ê°€ëŠ¥í•œ ì „í™˜ ìƒíƒœ ì¡°íšŒ
          echo "Fetching available transitions..."
          TRANSITIONS_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X GET \
            -H "$AUTH_HEADER" \
            -H "Content-Type: application/json" \
            "$JIRA_BASE_URL/rest/api/2/issue/$JIRA_KEY/transitions")
          
          HTTP_CODE=$(echo $TRANSITIONS_RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          TRANSITIONS_BODY=$(echo $TRANSITIONS_RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Failed to get transitions. HTTP Code: $HTTP_CODE"
            echo "Response: $TRANSITIONS_BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error_message=Failed to fetch transitions (HTTP $HTTP_CODE)" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "Available transitions:"
          echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | "\(.id): \(.name)"'
          
          # "ì™„ë£Œ", "Done", "Close" ë“±ì˜ ì „í™˜ ID ì°¾ê¸°
          DONE_ID=$(echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | select(.name == "ì™„ë£Œ" or .name == "Done" or .name == "DONE" or .name == "Close" or .name == "Closed") | .id' | head -1)
          
          if [ -z "$DONE_ID" ] || [ "$DONE_ID" == "null" ]; then
            echo "âŒ No 'Done' transition found for $JIRA_KEY"
            echo "Available transitions:"
            echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | "- \(.name) (ID: \(.id))"'
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error_message=No Done transition available" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "Found transition ID: $DONE_ID"
          echo "Transitioning $JIRA_KEY to Done..."
          
          # ì´ìŠˆ ìƒíƒœ ì „í™˜
          TRANSITION_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
            -H "$AUTH_HEADER" \
            -H "Content-Type: application/json" \
            -d "{\"transition\":{\"id\":\"$DONE_ID\"}}" \
            "$JIRA_BASE_URL/rest/api/2/issue/$JIRA_KEY/transitions")
          
          HTTP_CODE=$(echo $TRANSITION_RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          TRANSITION_BODY=$(echo $TRANSITION_RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
          
          if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Successfully closed $JIRA_KEY"
          else
            echo "âŒ Failed to transition issue. HTTP Code: $HTTP_CODE"
            echo "Response: $TRANSITION_BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error_message=Failed to transition issue (HTTP $HTTP_CODE)" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Add comment to GitHub
        if: ${{ steps.extract-issue-key.outputs.jira_key != '' }}
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ğŸ¯ Jira ì´ìŠˆ ìƒíƒœ ì—…ë°ì´íŠ¸
            
            **Jira Issue:** [${{ steps.extract-issue-key.outputs.jira_key }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-issue-key.outputs.jira_key }})
            **ì´ì „ ìƒíƒœ:** ${{ steps.close-issue.outputs.current_status || 'Unknown' }}
            **ê²°ê³¼:** ${{ steps.close-issue.outputs.already_done == 'true' && 'ì´ë¯¸ ì™„ë£Œë¨' || (steps.close-issue.outputs.success == 'true' && 'âœ… ì™„ë£Œ ì²˜ë¦¬ë¨' || 'âŒ ì™„ë£Œ ì‹¤íŒ¨') }}
            ${{ steps.close-issue.outputs.error_message && format('**ì˜¤ë¥˜:** {0}', steps.close-issue.outputs.error_message) || '' }}
            **íŠ¸ë¦¬ê±°:** GitHub Issue ë‹«í˜
            
            ğŸ”— **Jiraì—ì„œ í™•ì¸**: [ì´ìŠˆ ë³´ê¸°](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-issue-key.outputs.jira_key }})
